---
title: "Common Loon Analysis"
author: "Ellie Gabrielson, Will Draxler, Autumn Pauly"
output: github_document
---
# Background Information
## Introduction
Although Common Loons (Gavia immer) have been studied extensively during the breeding season not much is known of their behavior on their ocean wintering grounds, where Loons spend a significant part of their lives (Bent, 2009). The few studies that do look at winter behavior often yield conflicting results (McIntyre, 1978; Daub, 1989; Ford and Gieg, 1995). The possible use of different shoreline habitats for activities such as feeding, sleeping, or taking shelter is worthy of study. McIntyre (1978) found common loons were semi-social and formed loose rafts and that loon behavior varied with tides, weather, and time of day. Daub (1989) and later Ford and Gieg (1995) found refuting evidence suggesting loons were neither social nor territorial, and did not change their behavior much by tide. Holm and Burger (2002) found that the general pattern for loons was that they foraged during slack and main-flow water. Additionally, the possible difference in dive times as a result of varying tidal heights is worthy of study. Thompson and Price (2006) observed that dive times were longer during low tide in comparison to other tidal stages, though more studies should be conducted to assess the use of tidal stage and behavior. 

Our general hypothesis when analyzing this data is that environmental conditions affect the behavior of the G. immer. The null hypothesis to this statement is that environmental conditions do not affect the behavior of the G. immer.

## Methods
In 2023, observations were conducted at nine established observation sites along the coastline of Mount Desert Island in Hancock County (Maine). Observations occurred from January 2023 to March 2023 on a biweekly basis, where each waterfowl individual was recorded as well as their behaviors, referencing Daub’s (1989) list of behaviors, and coordinate location. Locational coordinates were obtained by estimating the individual’s rough location digitally (accurate to + or - 10 m). Each transect site was visited for roughly 5-10 minutes, where data collection followed initial observation. Utilizing a Kestrel 2500, weather data was recorded accurately to + or - 1°C of temperatures and within 3% of wind speed. Referencing Daub’s (1989) list of behaviors, each species’ behavior during the observation was noted. The weather and environmental data recorded included wind speed and direction, barometer, cloud cover, precipitation, humidity, temperature, tidal percentage, and wave class (Beaufort Wind Speed). Tidal data was gathered from NOAA’s digital tidal charts. This study was repeated in 2024 with the addition of observational variables including species dive times and tidal height. 

# Load Packages and Data
```{r load-packages, message = FALSE}
#install.packages("tidyverse")
library(tidyverse)
library(rmarkdown)
library(scales)
library(ggridges)
library(rstatix)
library(parsnip)
```

```{r read-in-data}
loons_2023 <- read_csv("loons_2023.csv")
loons_2024 <- read_csv("loons_2024.csv")
```


We should bootstrap all of the tidal heights so that we have equal observations... maybe not? 

```{r bootstrapping}
#boot_loon_2023 <- loons_2023_behavior %>% 
 # specify(response = behavior) %>% 
 # generate(reps = 15000, type = "bootstrap")
```

# Tidal Condition and Behavior for 2023 and 2024

Hypothesis: Tidal height has a significant effect on G. immer behavior

Null Hypothesis: Tidal height will not have a significant effect on G. immer behavior

### Bootstrapping
```{r bootstrapping-tide-behavior}
# #download packages
# library(boot)
# 
# #this is the dataset that we want to sample from? 
# loon_tide_behavior <- loons_2023 %>% 
#   select(behavior, tide)
# 
# #function to obtain R-Squared from the data 
# rsq <- function(formula, data, indices)
# {
#   d <- data[indices,] # allows boot to select sample
#   fit <- lm(formula, data=d)
#   return(summary(fit)$r.square)
# } 
# 
# # bootstrapping with 1000 replications
# #loon_results <- boot(data=loon_tide_behavior, statistic=rsq,
#    #R=100, formula=behavior~tide)
# 
# # view results
# #loon_results
# #plot(loon_results)
# 
# # get 95% confidence interval
# #boot.ci(loon_results, type="bca")
```

```{r sampling-tides-behavior}
#this is the dataset that we want to sample from? 
loon_tide_behavior <- loons_2023 %>% 
  select(behavior, tide)

## Tide-Behavior visualizations - to be moved to analysis
loons_2023 %>% 
  count(behavior, tide) %>% 
  ggplot(aes(x = behavior, y = n)) +
  geom_col() +
  facet_wrap(~ tide) + 
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ 
  labs(title = "Count of Behavior", 
       subtitle = "by Tidal Stage", 
       x = "Behavior", 
       y = "Count")

#tidal stage count graph
loons_2023 %>% 
  count(tide) %>% 
  ggplot(aes(x = tide, y = n)) +
      geom_col() + 
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(title = "Count of Observations", 
       subtitle = "by Tidal Stage", 
       x = "Tidal Stage", 
       y = "Count")
```


We need to use a non-parametric test. Kruskal-Wallace

```{r}
#1 Tidal Condition and Behavior - 2024/2023

#Behavior_tide_ANOVA <- aov(meters_offshore ~ tide, data = loons_2023)
#summary(Behavior_tide_ANOVA)
```

### Chi-Squared Goodness of Fit Test

```{r}
table(loons_2023$tide, loons_2024$behavior)
```


### Kruskal-Wallis Test
A Kruskal-Wallis test is non-parametric method (a one-way ANOVA on ranks) to [insert more here]. Even though our sample sizes are different, we will still be able to use this test, as this test allows for independent samples that have equal or differing sample sizes. 

```{r kw-test-tide-behavior}
kw <- kruskal.test(behavior ~ tide, data = loons_2023)
kw
```

REPORT: The behavior of G. immer was significantly different at various tidal heights (Kruskal-Wallis chi-squared = 12.324, df = 2, p-value = 0.002109).

### Dunn Test
We now need to use the Dunn test to determine which groups are different. 

```{r dunn-test-tide-behavior}
#install packages
# install.packages("ggpubr")
# library(ggpubr)
 install.packages("rstatix")
 library(rstatix)

ggplot(data = loons_2023, mapping = aes(x = tide, y = ))

#dunn test
dtkw <- loons_2023 %>% dunn_test(behavior ~ tide, p.adjust.method = "bonferroni")
dtkw
```

REPORT: The behavior of G. immer at high tide was not significantly different from their behavior at low or high tide. The behavior of G. immer at low tide was significantly different from their behavior at mid tide [insert test here]. 

### Chi-Squared Table
We will be using a Pearson's χ2 test to assess the difference in the distributions of our categorical variables between two independent variables (`tide` and `behavior`). 

**behavior is dependent, is this a good analysis to use? 

```{r chi-squared-table-onlyloons}
#creating table for chi-squared test
#forchi <- loons_2023 %>% 
  #select(behavior, tide)

#chitable <- table(forchi$behavior, forchi$tide)

#chitable

#Pearson's Chi-squared test
#chisq.test(chitable, correct = FALSE)
```
Does this suggest that behavior is dependent on tidal height?
Let's ask Sean!


# Tidal Conditions and Dive Times - 2024

Hypothesis: Low tide will cause G. immer to have significantly longer dive times. 

Null Hypothesis: Low tide will not cause G. immer to have significantly longer dive times. 

```{r mutation, baby}
library(stringr)

loons_dive_2024 <- loons_2024 %>% 
  filter(species == "common_loon") %>% 
  select(tide, behavior, dive_time_obs, tidal_height) %>% 
  filter(dive_time_obs != "n/a") %>% 
  filter(dive_time_obs != "na")

loons_dive_2024 <- loons_dive_2024 %>% 
  separate_longer_delim(dive_time_obs, delim = ",")

loons_dive_2024 <- loons_dive_2024 %>%
  mutate(dive_time_obs = as.numeric(dive_time_obs))

loons_dive_2024 <- loons_dive_2024 %>% 
  mutate(general_tide = fct_recode(tide, "low" = "low_flood", 
                           "low" = "low_slack",
                           "mid" = "mid_flood",
                           "mid" = "mid_ebb",
                           "high" = "high_flood",
                           "high" = "high_slack",
                           "high" = "high_ebb"))
```

```{r}
loons_dive_2024$tide.f <- fct_relevel(loons_dive_2024$general_tide, c("low", "mid", "high"))

ggplot(data = loons_dive_2024, mapping = aes(x = tide.f, y = dive_time_obs)) + 
  geom_boxplot() +
  labs(title = "Tidal Conditions and Dive Times", 
       subtitle = "of Gavia immer", 
       x = "Tidal Stage", 
       y = "Dive Time (seconds)")
```

```{r}
woomaov = aov(dive_time_obs ~ general_tide, data = loons_dive_2024)
summary(woomaov)
TukeyHSD(woomaov)

#high to low
loons_dive_2024_1 <- loons_dive_2024 %>% 
  filter(general_tide == "high"|general_tide == "mid")

t.test(dive_time_obs ~ general_tide, data = loons_dive_2024_1)

#low to high
loons_dive_2024_1 <- loons_dive_2024 %>% 
  filter(general_tide == "high"|general_tide == "low")

t.test(dive_time_obs ~ general_tide, data = loons_dive_2024_1)

#low to mid
loons_dive_2024_1 <- loons_dive_2024 %>% 
  filter(general_tide == "mid"|general_tide == "low")

t.test(dive_time_obs ~ general_tide, data = loons_dive_2024_1)
```
REPORT: There was no significant difference between dive times during low tides and high tides [insert test stat] and between dive times during mid tides and high tides [insert test statistic]. The dive times during mid tides were significantly lower than dive times during low tides [insert test statistic]. 

The average dive time during high tide was 42.02 seconds, 30.6 seconds during mid tides, and 47.4 seconds during low tides. 

```{r adjusted-r-squared}

#setting linear model- using tidal height
times_vs_tide_model <- linear_reg() %>% 
  set_engine("lm") %>% 
  fit(dive_time_obs ~ tidal_height, data = loons_dive_2024)

#augmenting the weight data
times_vs_tide_model_augment <- augment(times_vs_tide_model$fit)

ggplot(times_vs_tide_model_augment, mapping = aes(x = .fitted, y = .resid)) +
  geom_jitter(alpha = 0.75) +
  geom_smooth(color = "black") +
  labs(x = "Predicted Dive Time", y = "Residuals")

#assessing the r-squared value
glance(times_vs_tide_model)$r.squared
```
R_SQUARED REPORT: The r-squared value is `[...]`, which means that the variable `general_tide` accounts for [...] of the variation in the dependent variable, `dive_time_obs`. 

# Exposure Level and Abundance - 2023

Hypothesis: Higher exposure level of location significantly positively affects G. immer presence. 

Null Hypothesis: Higher exposure level of location will not significantly positively affect G. immer presence. 

Predictor variable = categorical
outcome variable = quantitative
test = ANOVA

```{r}
loons_2023 %>% 
  ggplot(mapping = aes(x = shelter_gradient, y = specific_abundance)) + 
  geom_boxplot() +
  labs(title = "Common Loon Abundance", 
       subtitle = "by Shelter Gradient", 
       x = "Shelter Gradient", 
       y = "Abundance")
```

```{r}
#install packages
install.packages("ggridges")
library(ggridges)

loons_2023 %>% 
  ggplot(mapping = aes(x = specific_abundance)) +
  geom_histogram() +
  geom_density() + 
  facet_wrap(~shelter_gradient, ncol = 1)

#plot
loons_2023 %>% 
  ggplot(aes(x = specific_abundance, y = shelter_gradient, fill = shelter_gradient)) + 
  geom_density_ridges(alpha = 0.6, bins = 1) + 
  theme_ridges() + 
   theme(legend.position = "none", panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8))+
  theme_minimal() +
  scale_fill_viridis_d() +
  labs(title = "Common Loon Abundance", 
       subtitle = "by Shelter Gradient", 
       x = "Abundance", 
       y = "Shelter Gradient", 
       fill = "Shelter Gradient")
```

```{r}
abundanceexposureaov = aov(specific_abundance ~ shelter_gradient, data = loons_2023)
summary(abundanceexposureaov)
TukeyHSD(abundanceexposureaov)
```

REPORT: [insert report here]

# Exposure Level and Behavior

Hypothesis: Exposure level of location significantly impacts G. immer behavior. 

Null Hypothesis: Exposure level of location has no significant impact on G. immer behavior. 


```{r}
loons_2023 %>% 
  count(behavior, shelter_gradient) %>% 
  ggplot(aes(x = behavior, y = n)) +
  geom_col(fill = "firebrick4", color = "black") +
  facet_wrap(~ shelter_gradient, nrow = 1) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Count of Common Loon Behavior", 
       subtitle = "by Shelter Gradient", 
       x = "Behavior", 
       y = "Count")
```

```{r}
behavior_exposure_kruskal <- kruskal.test(behavior ~ shelter_gradient, data = loons_2023)
behavior_exposure_kruskal

behavior_exposure_dunn <- loons_2023 %>% dunn_test(behavior ~ shelter_gradient, p.adjust.method = "bonferroni")
behavior_exposure_dunn
```

### REPORT

#Wave Class and Behavior

Hypothesis: Wave class will significantly affect G. immer behavior.

Null Hypothesis: Wave class will not significantly affect G. immer behavior.

```{r}
loons_2023 %>% 
 ggplot(aes(x = wave_class)) +
  geom_histogram() +
  facet_wrap(~ behavior, nrow = 1)

loons_2023 %>%
  ggplot(aes(x = wave_class, y = behavior, fill = behavior)) + 
  geom_density_ridges(alpha = 0.6, bins = 1)

waveclassaov = aov(wave_class ~ behavior, data = loons_2023)
summary(waveclassaov)
  
```
# Wave class did not significantly affect G. immer behavior (one-way ANOVA, F_4,126 = 2.356, P = 0.0572).

#Meters Offshore and Dive Times

Hypothesis: Distance from shore will significantly affect G. immer dive times. 

Null Hypothesis: Distance from shore will not significantly affect G. immer dive times.

#With the dive time and how many meters offshore the loon was seen are both quantitative variables, we should use a simple regression statistical test to determine if there is a statistical significance between the location of the loons (by meters offshore) and their dive times. 

```{r}
loons_dive_2024 <- loons_2024 %>% 
  filter(species == "common_loon") %>% 
  select(tide, behavior, dive_time_obs, tidal_height, meters_offshore) %>% 
  filter(dive_time_obs != "n/a") %>% 
  filter(dive_time_obs != "na")

loons_dive_2024 <- loons_dive_2024 %>% 
  separate_longer_delim(dive_time_obs, delim = ",") %>% 
  mutate(dive_time_obs = as.numeric(dive_time_obs))

loons_dive_2024 %>% 
  ggplot(aes(x = meters_offshore, y = dive_time_obs)) + 
  geom_jitter() + 
  geom_smooth(method = "lm")

#linear model
loon.dive.meters.lm <- lm(dive_time_obs ~ meters_offshore, data = loons_dive_2024)

summary(loon.dive.meters.lm)

#Cedar suggested that the p-values aren't really an indication of the fit with linear models, that's the r2 which is fine
```
# A linear model demonstrated a significant positive relationship between dive time and meters off shore (F1,89 = 27.81 : p = <0.5). 24% of the total variability in dive time can be predicted through a knowledge of meters off shore.

#Tidal height and dive times

Hypothesis: Tidal height will significantly affect G. immer dive times.

Null Hypothesis: Tidal height will not significantly affect G. immer dive times.

```{r}
loons_dive_2024 %>% 
  ggplot(aes(x = tidal_height, y = dive_time_obs)) + 
  geom_point() +
  geom_smooth(method = "lm")


dive_time_tide_height_lm <- lm(dive_time_obs ~ tidal_height, data = loons_dive_2024)
summary(dive_time_tide_height_lm)

#This is actually so interesting
```
# A linear model demonstrated no significant relationship between dive time and tidal height (F1,88 = 0.014 : p = 0.91).

#Tidal classification and dive times

Hypothesis: Tidal class will significantly affect G. immer dive times.

Null Hypothesis: Tidal class will not significantly affect G. immer dive times.

```{r}
loons_dive_2024$tide <- fct_relevel(loons_dive_2024$tide, c("mid_ebb",
                                                            "low_slack",
                                                            "low_flood",
                                                            "mid_flood",
                                                            "high_flood",
                                                            "high_slack",
                                                            "high_ebb"))
loons_dive_2024 %>% 
ggplot(mapping = aes(x = tide, y = dive_time_obs)) + 
  geom_boxplot()
full_tide_aov = aov(dive_time_obs ~ tide, data = loons_dive_2024)
summary(full_tide_aov)
TukeyHSD(full_tide_aov)
#Is this useful?
```


# Discussion / Conclusion

# Citations
Bent, A. C. 2009. Life Histories of North American Diving Birds. Cornell University Press: Ithaca, New York.

Daub, B. C. 1989. Behavior of Common Loons in Winter. Journal of Field Ornithology 60: 305-311.

Ford, T. B. and Gieg, J. A. 1995. Winter Behavior of the Common Loon. Journal of Field Ornithology 66: 22-29.

McIntyre, J. W. 1978. Wintering Behavior of Common Loons. The Auk 95: 396-403.

Holm, K. and Burger, A. 2002. Foraging Behavior and Resource Partitioning by Diving Birds During Winter in Areas of Strong Tidal Currents. Waterbirds 25(3): 312-325.

Thompson, Stephanie A. & Price, J. J. (2006). Water Clarity and Diving Behavior in Wintering Common Loons. Waterbirds: The International Journal of Waterbird Biology, 29(2), 169–175.
