---
title: "Winter Habitat Use by Common Loons (Gavia Immer)"
subtitle: "on Mount Desert Island, Maine"
author: "Ellie Gabrielson, Will Draxler, Autumn Pauly"
date: "03/12/2024"
output: 
  html_document: 
    toc: true
---
# Background Information
## Introduction
Although Common Loons (Gavia immer) have been studied extensively during the breeding season not much is known of their behavior on their ocean wintering grounds, where Loons spend a significant part of their lives (Bent, 2009). The few studies that do look at winter behavior often yield conflicting results (McIntyre, 1978; Daub, 1989; Ford and Gieg, 1995). The possible use of different shoreline habitats for activities such as feeding, sleeping, or taking shelter is worthy of study. McIntyre (1978) found common loons were semi-social and formed loose rafts and that loon behavior varied with tides, weather, and time of day. Daub (1989) and later Ford and Gieg (1995) found refuting evidence suggesting loons were neither social nor territorial, and did not change their behavior much by tide. Holm and Burger (2002) found that the general pattern for loons was that they foraged during slack and main-flow water. Additionally, the possible difference in dive times as a result of varying tidal heights is worthy of study. Thompson and Price (2006) observed that dive times were longer during low tide in comparison to other tidal stages, though more studies should be conducted to assess the use of tidal stage and behavior. 

Our general hypothesis when analyzing this data is that environmental conditions affect the behavior of the *G. immer*. The null hypothesis to this statement is that environmental conditions do not affect the behavior of the *G. immer*.

## Methods
In 2023, observations were conducted at nine established observation sites along the coastline of Mount Desert Island in Hancock County (Maine). Observations occurred from January 2023 to March 2023 on a biweekly basis, where each waterfowl individual was recorded as well as their behaviors, referencing Daub’s (1989) list of behaviors, and coordinate location. Locational coordinates were obtained by estimating the individual’s rough location digitally (accurate to + or - 10 m). Each transect site was visited for roughly 5-10 minutes, where data collection followed initial observation. Utilizing a Kestrel 2500, weather data was recorded accurately to + or - 1°C of temperatures and within 3% of wind speed. Referencing Daub’s (1989) list of behaviors, each species’ behavior during the observation was noted. The weather and environmental data recorded included wind speed and direction, barometer, cloud cover, precipitation, humidity, temperature, tidal percentage, and wave class (Beaufort Wind Speed). Tidal data was gathered from NOAA’s digital tidal charts. This study was repeated in 2024 with the addition of observational variables including species dive times and tidal height. 

# Data Analysis
## Load Packages and Data
```{r load-packages, message = FALSE, warning=FALSE}
#install.packages("tidyverse")
library(tidyverse)
library(rmarkdown)
library(scales)
library(ggridges)
library(rstatix)
library(parsnip)
```

```{r read-in-data, message = FALSE, warning=FALSE}
loons_2023 <- read_csv("loon_2023_tidy.csv")
loons_2024 <- read_csv("loon_2024_tidy.csv")
```

## Tidal Condition and Behavior for 2023

The first analysis that will be conducted will be investigating the potential relationship between tidal condition and *G. immer* behavior. As was stated above, the behaviors chosen are referencing Daub’s (1989) list of behaviors. The tidal condition was sorted into three categories: `high`, `mid`, and `low`. 

Hypothesis: Tidal height has a significant effect on *G. immer* behavior
Null Hypothesis: Tidal height will not have a significant effect on *G. immer* behavior

The null hypothesis for this analysis suggests that behaviors of Common Loons will be dependent of tidal condition, whilst the hypothesis suggests the opposite. 

### Visualizations

```{r sampling-tides-behavior, echo=FALSE}
loons_2023 %>% 
  count(behavior, tide) %>% 
  ggplot(aes(x = behavior, y = n)) +
  geom_col() +
  facet_wrap(~ tide) + 
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ 
  labs(title = "Count of Behavior", 
       subtitle = "by Tidal Stage", 
       x = "Behavior", 
       y = "Count")

#tidal stage count graph
loons_2023 %>% 
  count(tide) %>% 
  ggplot(aes(x = tide, y = n)) +
      geom_col() + 
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(title = "Count of Observations", 
       subtitle = "by Tidal Stage", 
       x = "Tidal Stage", 
       y = "Count")
```

### Statistics
#### Chi-Squared Test of Independence
The Chi-Squared Test of Independence examines whether there is a relationship between two categorical variables. Our null hypothesis, that tidal height will not have a significant effect on *G. immer* behavior, assumes that tidal condition and behavior are independent. Our hypothesis, that tidal height will have a significant effect on *G. immer* behavior, assumes that tidal condition and behavior are dependent.

#### Expected Frequencies and Contingency Table
Before performing the chi-square test, we need to calculate the expected frequencies for each cell in the contingency table. These expected frequencies represent what you would expect to observe if there were no association between tidal condition and behavior.

```{r contingency-table, echo=FALSE}
contingency_table1 <- table(loons_2023$tide, loons_2023$behavior)
contingency_table1
```

#### Chi-square Test
Now that we have the contingency table of expected frequencies, we can perform the statistical test. 

```{r chi-square-test, warning=FALSE, echo=FALSE}
chi_sq_test1 <- chisq.test(contingency_table1)
chi_sq_test1

# # x-squared
# chi_sq_test1$statistic
# 
# #p-value
# chi_sq_test1$p.value
# 
# #expected frequencies
# chi_sq_test1$expected
```

REPORT: The behavior of Common Loons is dependent on tidal condition (Pearson's Chi-squared test; X-squared = 33.184, df = 10, p-value > 0.005). 

## Tidal Conditions and Dive Times in 2024

The second analysis that will be conducted will be investigating the potential relationship between tidal condition and *G. immer* dive times. The null hypothesis for this analysis suggests that dive times of *G. immer* will be dependent of tidal condition, whilst the hypothesis suggests the opposite. 

Hypothesis: Low tide will cause *G. immer* to have significantly longer dive times. 
Null Hypothesis: Low tide will not cause *G. immer* to have significantly longer dive times. 

```{r message=FALSE, echo=FALSE, warning=FALSE}
library(stringr)
library(ggpubr)
library(tidymodels)
```

```{r mutation, baby, echo=FALSE, message=FALSE, warning=FALSE}
loons_dive_2024 <- loons_2024 %>% 
  filter(species == "common_loon") %>% 
  select(tide, behavior, dive_time_obs, tidal_height) %>% 
  filter(dive_time_obs != "n/a") %>% 
  filter(dive_time_obs != "na")

loons_dive_2024 <- loons_dive_2024 %>% 
  separate_longer_delim(dive_time_obs, delim = ",")

loons_dive_2024 <- loons_dive_2024 %>%
  mutate(dive_time_obs = as.numeric(dive_time_obs))

loons_dive_2024 <- loons_dive_2024 %>% 
  mutate(general_tide = fct_recode(tide, "low" = "low_flood", 
                           "low" = "low_slack",
                           "mid" = "mid_flood",
                           "mid" = "mid_ebb",
                           "high" = "high_flood",
                           "high" = "high_slack",
                           "high" = "high_ebb"))
```

### Randomly Sampling
As can be seen in the histograms below, we do not have a normal distribution of data during any of the tidal cycles. To mitigate this, we will be randomly sampling dive times during each tidal stage 100 times. 

```{r , warning=FALSE, echo=FALSE}
ggplot(data = loons_dive_2024, mapping = aes(x = dive_time_obs)) + 
  geom_histogram()+ 
  facet_wrap(~general_tide)
```

```{r, warning=FALSE}
#low tide
loons_lowdive_2024 <- loons_dive_2024 %>% 
  filter(general_tide == "low") %>% 
  select(dive_time_obs)

set.seed(101)

sampled_low <- loons_lowdive_2024 %>%
  specify(response = dive_time_obs) %>% 
  generate(reps = 1000, type = "bootstrap") %>% 
  calculate(stat = "mean")

sampled_low <- sampled_low %>% 
  mutate(replicate = as.character(replicate)) %>% 
  mutate(tide = if_else(replicate != 0, "low", replicate)) %>% 
  select(tide, stat)

#mid tide
loons_middive_2024 <- loons_dive_2024 %>% 
  filter(general_tide == "mid") %>% 
  select(dive_time_obs)

set.seed(101)

sampled_mid <- loons_middive_2024 %>%
  specify(response = dive_time_obs) %>% 
  generate(reps = 1000, type = "bootstrap") %>% 
  calculate(stat = "mean")

sampled_mid <- sampled_mid %>% 
  mutate(replicate = as.character(replicate)) %>% 
  mutate(tide = if_else(replicate != 0, "mid", replicate)) %>% 
  select(tide, stat)

#high tide
loons_highdive_2024 <- loons_dive_2024 %>% 
  filter(general_tide == "high") %>% 
  select(dive_time_obs)

set.seed(101)

sampled_high <- loons_highdive_2024 %>%
  specify(response = dive_time_obs) %>% 
  generate(reps = 1000, type = "bootstrap") %>% 
  calculate(stat = "mean")

sampled_high <- sampled_high %>% 
  mutate(replicate = as.character(replicate)) %>% 
  mutate(tide = if_else(replicate != 0, "high", replicate)) %>% 
  select(tide, stat)

#joining dataset
dive_samples <- rbind(sampled_low, sampled_high)
dive_samples <- rbind(dive_samples, sampled_mid)
```

Now, we can see that we have a normal distribution of dive times during all tidal cycles, which now makes an ANOVA an appropriate statistical test to use for this data frame. 

```{r sampledivetimes, warning=FALSE, echo=FALSE}
ggplot(data = dive_samples, mapping = aes(x = stat)) + 
  geom_histogram() + 
  facet_wrap(~tide, ncol = 1) + 
  theme_minimal() +
  labs(title = "Dive Times of Common Loons", 
       subtitle = "during low, mid, and high tide", 
       x = "Dive Time (seconds)", 
       y = "Count")
```

### Visualizations
Below we are visualizing dive times in the form of a boxplot. As we can see below, it appears as though the dive times are longest during low tide, followed by second longest during high tide, and shortest during low tide. We will need to perform statistical tests to see if there are any significant differences between the tidal stages.  

```{r echo=FALSE, warning=FALSE}
dive_samples$tide <- fct_relevel(dive_samples$tide, c("low", "mid", "high"))

ggplot(data = dive_samples, mapping = aes(x = tide, y = stat)) + 
  geom_boxplot() +
  labs(title = "Tidal Conditions and Dive Times", 
       subtitle = "of Gavia immer", 
       x = "Tidal Stage", 
       y = "Dive Time (seconds)")
```

### Statistics
To determine if there is a significant difference in dive times of Common loons during different tidal stages, where the tidal stages are categorical with three levels (high tide, mid tide, and low tide), and the dive time is a continuous numerical variable, a one-way analysis of variance (ANOVA) will be used. 

```{r diveaov, echo=FALSE}
diveaov = aov(stat ~ tide, data = dive_samples)
```

```{r anova2,warning=FALSE, echo=FALSE}
summary(diveaov)
TukeyHSD(diveaov)
```

```{r ,message=FALSE, echo=FALSE, warning=FALSE}
#high to low
loons_dive_2024_1 <- dive_samples %>%
  filter(tide == "high"|tide == "mid")

t.test(stat ~ tide, data = loons_dive_2024_1)

#low to high
loons_dive_2024_1 <- dive_samples %>%
  filter(tide == "high"|tide == "low")

t.test(stat ~ tide, data = loons_dive_2024_1)

#low to mid
loons_dive_2024_1 <- dive_samples %>%
  filter(tide == "mid"|tide == "low")

t.test(stat ~ tide, data = loons_dive_2024_1)
```

REPORT: An analysis of variance (ANOVA) on these dive times yielded significant variation among various tidal stages (One-Way ANOVA; F(2,2997) = 5713, p <0.005). A post hoc Tukey HSD test showed that each tidal stage differed significantly from each other (Figure above). The average dive time during high tide was 41.97 seconds, 30.4 during mid tide, and 47.45 during low tide. 

## Exposure Level and Abundance in 2023

The third analysis that will be conducted will be investigating the potential relationship between exposure level and *G. immer* abundance during the 2023 observation period. The null hypothesis for this analysis suggests that *G. immer* abundance will be independent of exposure level, whilst the hypothesis suggests the opposite. 

Null Hypothesis: Higher exposure level of location will not significantly positively affect *G. immer* presence.  

Hypothesis: Higher exposure level of location significantly positively affects *G. immer* presence. 

### Visualizations
Below we are visualizing abundance in the form of boxplots. 

As we can see below, it appears as though there is the highest abundance at locations that are exposed and the lowest abundance at locations that are sheltered. Statistical tests will need to be performed to see if there is a significant difference in the abundances at different exposure levels. 

```{r warning=FALSE, echo=FALSE}
loons_2023 %>% 
  ggplot(mapping = aes(x = shelter_gradient, y = specific_abundance)) + 
  geom_boxplot() +
  labs(title = "Common Loon Abundance", 
       subtitle = "by Shelter Gradient", 
       x = "Shelter Gradient", 
       y = "Abundance")
```

```{r warning=FALSE, echo=FALSE}
loons_2023 %>% 
  ggplot(mapping = aes(x = specific_abundance)) +
  geom_histogram() +
  geom_density() + 
  facet_wrap(~shelter_gradient, ncol = 2)
```


```{r warning=FALSE, echo=FALSE}
#plot
loons_2023 %>% 
  ggplot(aes(x = specific_abundance, y = shelter_gradient, fill = shelter_gradient)) + 
  geom_density_ridges(alpha = 0.6, bins = 1) + 
  theme_ridges() + 
   theme(legend.position = "none", panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8))+
  theme_minimal() +
  scale_fill_viridis_d() +
  labs(title = "Common Loon Abundance", 
       subtitle = "by Shelter Gradient", 
       x = "Abundance", 
       y = "Shelter Gradient", 
       fill = "Shelter Gradient")
```

### Statistics
To determine if there is a significant difference in the abundance of *G. immer* in locations with varying exposure levels, where the exposure levels are categorical variable with five levels (exposed, moderately exposed, moderate, moderately sheltered, and sheltered), and the abundance is a continuous numerical variable, a one-way analysis of variance (ANOVA) will be used. 

```{r}
abundanceexposureaov = aov(specific_abundance ~ shelter_gradient, data = loons_2023)
summary(abundanceexposureaov)
TukeyHSD(abundanceexposureaov)
```

REPORT: An Analysis of Variance test demonstrated that coastal exposure level has a significant effect on the abundance of *G. immer* (ANOVA, F_4,126 = 6.167; p = 0.000145). 
An unplanned analytical comparison demonstrated that *G. immer* presence [finish this]. 

## Exposure Level and Behavior

The third analysis that will be conducted will be investigating the potential relationship between exposure level and *G. immer* behavior during the 2023 observation period. The null hypothesis for this analysis suggests that *G. immer* behavior will be independent of exposure level, whilst the hypothesis suggests the opposite. 

Null Hypothesis: Exposure level of location has no significant impact on *G. immer* behavior. 

Hypothesis: Exposure level of location significantly impacts *G. immer* behavior. 

### Visualizations

```{r}
loons_2023 %>% 
  count(behavior, shelter_gradient) %>% 
  ggplot(aes(x = behavior, y = n)) +
  geom_col(fill = "firebrick4", color = "black") +
  facet_wrap(~ shelter_gradient, nrow = 1) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Count of Common Loon Behavior", 
       subtitle = "by Shelter Gradient", 
       x = "Behavior", 
       y = "Count")
```

### Statistics

```{r, warning=FALSE, echo=FALSE}
behavior_exposure_kruskal <- kruskal.test(behavior ~ shelter_gradient, data = loons_2023)
behavior_exposure_kruskal

behavior_exposure_dunn <- loons_2023 %>% dunn_test(behavior ~ shelter_gradient, p.adjust.method = "bonferroni")
behavior_exposure_dunn
```

#### Chi-Squared Test of Independence
The Chi-Squared Test of Independence examines whether there is a relationship between two categorical variables. Our null hypothesis, that exposure will not have a significant effect on *G. immer* behavior, assumes that exposure level and behavior are independent.

#### Expected Frequencies and Contingency Table
Before performing the chi-square test, we need to calculate the expected frequencies for each cell in the contingency table. These expected frequencies represent what you would expect to observe if there were no association between exposure and behavior.

```{r contingency-table2, echo=FALSE}
contingency_table2 <- table(loons_2023$shelter_gradient, loons_2023$behavior)
contingency_table2
```

#### Chi-square Test
Now that we have the contingency table of expected frequencies, we can perform the statistical test. 

```{r chi-square-test2, warning=FALSE, echo=FALSE}
chi_sq_test2 <- chisq.test(contingency_table2)
chi_sq_test2
```

REPORT: There was no significant association between exposure level and behavior, so there is no need for a Post-hoc test. 

#### Bonferroni Adjustment
[insert section about what a bonferroni adjustment is]

```{r}
#calculating expected vs. observed frequencies
observed <- chi_sq_test2$observed
expected <- chi_sq_test2$expected

#calculating residuals
residuals <- observed - expected

#calculate number of exposure levels
n_levels <- nrow(contingency_table2)

#creating matrix to store p-vales for pairwise comparison
p_values <- matrix(NA, ncol = n_levels, nrow = n_levels)

#pairwise comparison
for (i in 1:(n_levels - 1)) {
  for (j in (i + 1):n_levels) {

#Calculate standardized residuals for the cell (i, j)
cell_residual <- residuals[i, j]
    
#calculate Bonferroni-adjusted p-value
    p_values[i, j] <- pchisq(cell_residual^2, df = 1, lower.tail = FALSE) * (n_levels * (n_levels - 1)) / 2
  }
}

p_values <- p_values + t(p_values)
diag(p_values) <- 1  # Set diagonal to 1 since we're not interested in self-comparisons

p_value
```

REPORT: 

## Wave Class and Behavior

Hypothesis: Wave class will significantly affect *G. immer* behavior.

Null Hypothesis: Wave class will not significantly affect *G. immer* behavior.

### Visualizations

```{r}
loons_2023 %>% 
 ggplot(aes(x = wave_class)) +
  geom_histogram() +
  facet_wrap(~ behavior, nrow = 1)

loons_2023 %>%
  ggplot(aes(x = wave_class, y = behavior, fill = behavior)) + 
  geom_density_ridges(alpha = 0.6, bins = 1)
```

### Statistics

```{r}
waveclassaov = aov(wave_class ~ behavior, data = loons_2023)
summary(waveclassaov)
```


Wave class did not significantly affect *G. immer* behavior (one-way ANOVA, F_4,126 = 2.356, P = 0.0572).

## Meters Offshore and Dive Times

Hypothesis: Distance from shore will significantly affect *G. immer* dive times. 

Null Hypothesis: Distance from shore will not significantly affect *G. immer* dive times.

### Visualizations

```{r}
loons_dive_2024 <- loons_2024 %>% 
  filter(species == "common_loon") %>% 
  select(tide, behavior, dive_time_obs, tidal_height, meters_offshore) %>% 
  filter(dive_time_obs != "n/a") %>% 
  filter(dive_time_obs != "na")

loons_dive_2024 <- loons_dive_2024 %>% 
  separate_longer_delim(dive_time_obs, delim = ",") %>% 
  mutate(dive_time_obs = as.numeric(dive_time_obs))

loons_dive_2024 %>% 
  ggplot(aes(x = meters_offshore, y = dive_time_obs)) + 
  geom_jitter() + 
  geom_smooth(method = "lm")
```

### Statistics

```{r}
#linear model
loon.dive.meters.lm <- lm(dive_time_obs ~ meters_offshore, data = loons_dive_2024)

summary(loon.dive.meters.lm)
```


A linear model demonstrated a significant positive relationship between dive time and meters off shore (F1,89 = 27.81 : p = <0.5). 24% of the total variability in dive time can be predicted through a knowledge of meters off shore.

## Tidal height and dive times

Hypothesis: Tidal height will significantly affect *G. immer* dive times.

Null Hypothesis: Tidal height will not significantly affect *G. immer* dive times.

### Visualizations

```{r}
loons_dive_2024 %>% 
  ggplot(aes(x = tidal_height, y = dive_time_obs)) + 
  geom_point() +
  geom_smooth(method = "lm")
```

### Statistics

```{r}
dive_time_tide_height_lm <- lm(dive_time_obs ~ tidal_height, data = loons_dive_2024)
summary(dive_time_tide_height_lm)

#This is actually so interesting
```


A linear model demonstrated no significant relationship between dive time and tidal height (F1,88 = 0.014 : p = 0.91).

## Tidal classification and dive times

Hypothesis: Tidal class will significantly affect *G. immer* dive times.

Null Hypothesis: Tidal class will not significantly affect *G. immer* dive times.

### Visualizations

```{r}
loons_dive_2024$tide <- fct_relevel(loons_dive_2024$tide, c("mid_ebb",
                                                            "low_slack",
                                                            "low_flood",
                                                            "mid_flood",
                                                            "high_flood",
                                                            "high_slack",
                                                            "high_ebb"))
loons_dive_2024 %>% 
ggplot(mapping = aes(x = tide, y = dive_time_obs)) + 
  geom_boxplot()
```

### Statistics

```{r}
full_tide_aov = aov(dive_time_obs ~ tide, data = loons_dive_2024)
summary(full_tide_aov)
TukeyHSD(full_tide_aov)
```

An Analysis of Variance test demonstrated that tidal class has a significant effect on the length of *G. immer* dive times (ANOVA, F_6,86 = 4.599; p = 0.000427). An uplanned analytical comparison demonstrated that *G. immer* dive times at low slack tide were signficantly different than those at mid ebb tide (TukeyB, p < 0.0005055), and dive lengths at high ebb tide were significantly different than those at mid ebb tide (TukeyB, p = 0.0017457). Otherwise, there were no significant differences in dive times between other tidal classes (TukeyB, p > 0.05)

# Discussion / Conclusion

# Citations
Bent, A. C. 2009. Life Histories of North American Diving Birds. Cornell University Press: Ithaca, New York.

Daub, B. C. 1989. Behavior of Common Loons in Winter. Journal of Field Ornithology 60: 305-311.

Ford, T. B. and Gieg, J. A. 1995. Winter Behavior of the Common Loon. Journal of Field Ornithology 66: 22-29.

McIntyre, J. W. 1978. Wintering Behavior of Common Loons. The Auk 95: 396-403.

Holm, K. and Burger, A. 2002. Foraging Behavior and Resource Partitioning by Diving Birds During Winter in Areas of Strong Tidal Currents. Waterbirds 25(3): 312-325.

Thompson, Stephanie A. & Price, J. J. (2006). Water Clarity and Diving Behavior in Wintering Common Loons. Waterbirds: The International Journal of Waterbird Biology, 29(2), 169–175.
