---
title: "Winter Habitat Use by Common Loons (Gavia Immer) in 2024"
subtitle: "on Mount Desert Island, Maine"
author: "Draxler and Pauly"
date: "03/12/2024"
output: 
  html_document: 
    toc: true
---

# Data Analysis
## Load Packages and Data
```{r load-packages, message = FALSE, warning=FALSE}
#install.packages("tidyverse")
library(tidyverse)
library(rmarkdown)
library(scales)
library(ggridges)
library(rstatix)
library(parsnip)
```

```{r read-in-data, message = FALSE, warning=FALSE}
loons_2024 <- read_csv("loons_dive_2024.csv")
```

## Diving Loons 2024
```{r}
loons_dive_2024 <- loons_2024 %>% 
  select(tide, behavior, dive_time_obs, tidal_height, latitude, longitude, meters_offshore, location, general_tide) %>% 
  filter(dive_time_obs != "n/a") %>% 
  filter(dive_time_obs != "na")

loons_dive_2024 <- loons_dive_2024 %>% 
  separate_longer_delim(dive_time_obs, delim = ",")

loons_dive_2024 <- loons_dive_2024 %>%
  mutate(dive_time_obs = as.numeric(dive_time_obs))

loons_dive_2024 <- loons_dive_2024 %>% 
  mutate(general_tide = fct_recode(tide, "low" = "low_flood", 
                           "low" = "low_ebb",
                           "low" = "low_slack",
                           "mid" = "mid_flood",
                           "mid" = "mid_ebb",
                           "high" = "high_flood",
                           "high" = "high_slack",
                           "high" = "high_ebb"))
```

## General Statistics
The mean dive time of loons during this study was 36.87 seconds with a standard error of 1.09.

```{r}
#summary of dive times in 2024
summary(loons_dive_2024)

#standard error function
std.error <- function(x) sd(x)/sqrt(length(x))

std.error(loons_dive_2024$dive_time_obs)
```






## General Tidal Stage and Abundance at each site

### Statistics
#### Chi-Squared Test of Independence
#### Expected Frequencies and Contingency Table
```{r contingency-table, echo=FALSE}
contingency_table_abun24 <- table(loons_dive_2024$tide, loons_dive_2024$location)
contingency_table_abun24
```

#### Chi-square Test
```{r chi-square-test, warning=FALSE, echo=FALSE}
chisq24abun <- chisq.test(contingency_table_abun24)
chisq24abun
```

REPORT: A Chi-squared test indicated a significant relationship between *G. immer* abundance and tidal condition at each site (X^2(16, n=131) = 26.28, df = 35, p-value > 0.005). This indicates that there is a relationship between tidal height and *G. immer* abundance at each site, allowing us to reject the null hypothesis.




```{r}
#the results suggested that there was a relationship - let's find out what this is. 

#should we pursue this?
```



## Behavior at Tidal Heights

```{r}
loons_2023 <- read_csv("loon_2023_tidy.csv")

loons_2023_behavior <- loons_2023 %>% select(behavior, general_tide)
loons_2024_behavior <- loons_dive_2024 %>% select(behavior, general_tide)
loons_behavior <- bind_rows(loons_2023_behavior, loons_2024_behavior)


contingency_table1 <- table(loons_2023_behavior$general_tide, loons_2023_behavior$behavior)
contingency_table1
```

```{r}
chi_sq_test1 <- chisq.test(contingency_table1)	
chi_sq_test1
```

REPORT: A Chi-squared test indicated a significant relationship between *G. immer* behavior and general tidal stage (X^2(12, n=307) = 75.8, df = 12, p-value > 0.005). This indicates that there is a relationship between general tidal stage and *G. immer* behavior, allowing the null hypothesis to be rejected.





## Tidal Conditions and Dive Times in 2024
```{r message=FALSE, echo=FALSE, warning=FALSE}
library(stringr)
library(ggpubr)
library(tidymodels)
library(tidyverse)
```

```{r mutation, baby, echo=FALSE, message=FALSE, warning=FALSE}
loons_dive_2024 <- loons_dive_2024 %>% 
  separate_longer_delim(dive_time_obs, delim = ",")

loons_dive_2024 <- loons_dive_2024 %>% 
  separate_wider_delim(latitude, delim = ",", names = c("latitude", "longitude2"), too_few = "align_start") %>% 
  mutate(longitude2 = as.numeric(longitude2)) %>% 
  mutate(latitude = as.numeric(latitude))

loons_dive_2024 <- loons_dive_2024 %>%
  mutate(dive_time_obs = as.numeric(dive_time_obs))

loons_dive_2024 <- loons_dive_2024 %>% 
  mutate(general_tide = fct_recode(tide, "low" = "low_flood",
                           "low" = "low_ebb",      
                           "low" = "low_slack",
                           "mid" = "mid_flood",
                           "mid" = "mid_ebb",
                           "high" = "high_flood",
                           "high" = "high_slack",
                           "high" = "high_ebb"))
```

```{r}
#This is specifically to export coordinates, I know it's big but I didn't have a better solution

loons_dive_2024_1 <- loons_dive_2024 %>% 
  filter(is.na(longitude2) == F ) %>% 
  mutate(longitude = longitude2) %>% 
  select(-longitude2)

loons_dive_2024_2 <- loons_dive_2024 %>% 
  filter(is.na(longitude) == F ) %>% 
  select(- longitude2)

loons_dive_2024 <- loons_dive_2024_1 %>% 
  bind_rows(loons_dive_2024_2) %>% 
  write_csv("loons_dive_2024_GPS.csv")

```

### Visualizations
```{r warning=TRUE, echo = FALSE}
ggplot(data = loons_dive_2024, mapping = aes(x = dive_time_obs)) +
  geom_histogram()+
  facet_wrap(~general_tide, ncol = 1) + 
  labs(title = "Distribution of Dive Times of G. Immer", 
       subtitle = "At various tidal stages", 
       x = "Dive Time (seconds)", 
       y = "Count")
```

#### Statistics 
```{r, warning=FALSE, echo=FALSE}
library(rstatix)
```

```{r}
#general tide
dive_kruskal <- kruskal.test(dive_time_obs ~ general_tide, data = loons_dive_2024)
dive_kruskal

#post-hoc test
dive_dunn <- loons_dive_2024 %>% dunn_test(dive_time_obs ~ general_tide, p.adjust.method = "bonferroni")
dive_dunn

#mean values
loons_dive_2024 %>% 
  select(dive_time_obs, general_tide) %>% 
  group_by(general_tide) %>% 
  mutate(mean_tide = mean(dive_time_obs)) %>% 
  distinct(general_tide, mean_tide)

#plot for dive times in general tide
divetimegglinegeneral <- ggline(loons_dive_2024, x = "general_tide", y = "dive_time_obs",
       add = c(add = "mean_se", "jitter"),
       order = c("high", "mid", "low"),
       ylab = "Dive Time (seconds)", xlab = "Tidal Stage", title = "")

divetimegglinegeneral + stat_compare_means(label.y = 75) + scale_x_discrete(labels = c("High", "Mid", "Low"))

```

REPORT: The Kruskal-Wallis test revealed that there was a significant difference in dive times among the general tidal stages (Kruskal-Wallis rank sum test; H(2) = 29.76, P > 0.005).












```{r}
#tide
dive_kruskal <- kruskal.test(dive_time_obs ~ tide, data = loons_dive_2024)
dive_kruskal

#post-hoc test
dive_dunn <- loons_dive_2024 %>% dunn_test(dive_time_obs ~ tide, p.adjust.method = "bonferroni")
dive_dunn

#mean values
loons_dive_2024 %>% 
  select(dive_time_obs, tide) %>% 
  group_by(tide) %>% 
  mutate(mean_tide = mean(dive_time_obs)) %>% 
  distinct(tide, mean_tide) %>% 
  arrange(desc(mean_tide))

#This is not working - putting in code jail

loons_dive_2024$tide <- factor(loons_dive_2024$tide, levels = c("high_ebb", "mid_ebb", "low_ebb", "low_slack", "low_flood","mid_flood", "high_flood", "high_slack"))

library(ggpubr)
library(RColorBrewer)
divetimeggline <- ggline(loons_dive_2024, x = "tide", y = "dive_time_obs",
       add = c(add = "mean_se", "jitter"),
       order = c("high_ebb", "mid_ebb", "low_ebb", "low_slack", "low_flood","mid_flood", "high_flood", "high_slack"),
       ylab = "Tidal Stage", xlab = "Dive Time (seconds)", title = "")

divetimeggline + stat_compare_means(label.y = 75) + 
  scale_x_discrete(name = "Dive Time (seconds)", 
                   labels=c("High Ebb", "Mid Ebb", "Low Ebb", "Low Slack", "Low Flood", "Mid Flood", "High Flood", "High Slack"))
```

```{r tidal-heights-and-dive-times}
ggplot(data = loons_dive_2024, mapping = aes(x = tide, y = dive_time_obs, fill = tide)) + 
  geom_boxplot() +
  scale_fill_brewer(palette = "YlGn") +
  labs(title = "", 
       x = "Tidal Stage", 
       y = "Dive Time (seconds)") + 
  guides(fill="none") + 
  theme_bw() + 
  scale_x_discrete(labels = c("High Ebb", "Mid Ebb", "Low Ebb", "Low Slack", "Low Flood", "Mid Flood", "High Flood", "High Slack")) + 
  coord_fixed(ratio = 0.07) + 
  theme(panel.background = element_rect(fill = "#e4f1e2ff")) + 
  theme(axis.text.x = element_text(angle = 25, vjust = 0.5, hjust=0.5))
```


REPORT: The Kruskal-Wallis test revealed that there was a significant difference in dive times among the general tidal stages (Kruskal-Wallis rank sum test; H(7) = 46.048, P > 0.005).

















## Meters Offshore and Dive Times
### Visualizations

```{r}
#Full data lm
meters_off_lm <- lm(dive_time_obs~meters_offshore, data = loons_dive_2024)
summary(meters_off_lm)

loons_dive_2024%>% 
  ggplot(aes(x = meters_offshore, y = dive_time_obs)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d(option = "A")

#Low tide lm
loons_dive_low_2024 <- loons_dive_2024 %>% 
  filter(general_tide == "low")

loons_dive_low_2024%>% 
  ggplot(aes(x = meters_offshore, y = dive_time_obs)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d(option = "A")

low_lm <- lm(dive_time_obs~meters_offshore, data = loons_dive_low_2024)
summary(low_lm)
```

### Statistics
```{r}
loons_dive_2024 %>% 
  ggplot(aes(x = meters_offshore, y = dive_time_obs)) + 
  geom_jitter() + 
  geom_smooth(method = "lm") + 
  labs(title = "Dive Times vs. Meters Offshore", 
       subtitle = "of G. immer", 
       x = "Distance Offshore (m)", 
       y = "Dive Time (seconds)")
```

```{r}
#Meters Offshore
ggplot(data = loons_dive_2024, mapping = aes(x = meters_offshore)) + 
  geom_histogram()

#Dive Times
ggplot(data = loons_dive_2024, mapping = aes(x = dive_time_obs)) + 
  geom_histogram()
```

#### Statistics
```{r warning=FALSE}
dive_wave_corr <- cor.test(x=loons_dive_2024$meters_offshore, y = loons_dive_2024$dive_time_obs, method = 'spearman')

dive_wave_corr
```

REPORT: A Spearman's correlation revealed a moderate positive monotonic relationship between the variables `meters_offshore` and `dive_time_obs` (rs[93] = .50, p < 0.005). This indicates that there is a statistically significant association between distance from shore and G. immer dive times, allowing us to reject the null hypothesis. This implies that G. immer may exhibit longer dive times when further from the shore.





#Tidal height
```{r}
#Tidal hight has no significant effect on dive time
tidal_height_lm <- lm(dive_time_obs~tidal_height, data = loons_dive_2024)
summary(tidal_height_lm)

loons_dive_2024%>% 
  ggplot(aes(x = meters_offshore, y = tidal_height)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d(option = "A")

#Differentiating by tidal height had no statistical significance
#Low tide lm
loons_dive_low_2024 <- loons_dive_2024 %>%
  filter(general_tide == "low")

loons_dive_mid_2024 <- loons_dive_2024 %>%
  filter(general_tide == "mid")

loons_dive_high_2024 <- loons_dive_2024 %>%
  filter(general_tide == "high")


high_tide_lm <- lm(dive_time_obs~tidal_height, data = loons_dive_high_2024)
summary(high_tide_lm)
```

```{r}
loons_dive_mid_2024%>% 
  ggplot(aes(x = meters_offshore, y = tidal_height)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d(option = "A")
```


#Water depth
```{r}
#Prep
loons_dive_2024_gis <- read_csv("loons_dive_2024_gis.csv")
  
dives_gis1 <- loons_dive_2024_gis %>% 
  filter(is.na(`RASTERVALU...11`) == F ) %>% 
  mutate(bathy_depth_m = `RASTERVALU...11`) %>% 
  select(-`RASTERVALU...11`)

dives_gis2 <- loons_dive_2024_gis %>% 
  filter(is.na(`RASTERVALU...12`) == F ) %>% 
  mutate( bathy_depth_m = `RASTERVALU...12`) %>% 
  select(-`RASTERVALU...12`)

loons_dive_2024_gis <- dives_gis1 %>% 
  bind_rows(dives_gis2) %>% 
  select(-RASTERVALU) %>%
  mutate(water_depth_m = (bathy_depth_m * -1) + tidal_height)

loons_dive_2024_gis <- loons_dive_2024_gis %>% 
  mutate(general_tide = fct_recode(tide, "low" = "low_flood", 
                           "low" = "low_ebb",
                           "low" = "low_slack",
                           "mid" = "mid_flood",
                           "mid" = "mid_ebb",
                           "high" = "high_flood",
                           "high" = "high_slack",
                           "high" = "high_ebb"))

#Analyze
water_depth_lm <- lm(dive_time_obs~water_depth_m, data = loons_dive_2024_gis)
summary(water_depth_lm)

loons_dive_2024_gis %>% 
  ggplot(aes(x = water_depth_m, y = dive_time_obs, color = general_tide)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d(option = "A")

#low specific

loons_dive_2024_gis_low <- loons_dive_2024_gis %>% 
  filter(general_tide == "low")

water_depth_low_lm <- lm(dive_time_obs~water_depth_m, data = loons_dive_2024_gis_low)
summary(water_depth_low_lm)

loons_dive_2024_gis_low %>% 
  ggplot(aes(x = water_depth_m, y = dive_time_obs)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  labs(
    title = "Water Depth and Dive Time at Low Tide",
    y = "Length of Dive Time (s)",
    x = "Depth at Location of Dive (m)"
  )
```

## POSTER - Linear Models - Distance Offshore at low tide
Linear model of relationship between the meters offshore at low tide and dive times of loons
```{r}
loons_2024_low <- loons_2024 %>% 
  filter(general_tide == "low")

#scatterplot
meters_offshore <- loons_2024_low$meters_offshore
dive_time_obs <- loons_2024_low$dive_time_obs

plot(meters_offshore, dive_time_obs, main="Distance Offshore and Dive Time at Low Tide", xlab="Distance Offshore (m)", ylab="Dive Time (second)", pch=19, col = "red")
abline(lm(dive_time_obs~meters_offshore), col="black") + 
  
```

### Statistics
```{r}
dive_metersoffshore_corr <- cor.test(x=loons_2024_low$meters_offshore, y = loons_2024_low$dive_time_obs, method = 'spearman')

dive_metersoffshore_corr
```

## POSTER - Linear Models - Depth and dive times at low tide
Linear model of relationship between the meters offshore at low tide and dive times of loons
```{r}
loons_2024_low <- loons_2024 %>% 
  filter(general_tide == "low")

#scatterplot
meters_offshore <- loons_dive_2024_gis_low$meters_offshore
dive_time_obs <- loons_dive_2024_gis_low$dive_time_obs

plot(meters_offshore, dive_time_obs, main="Distance Offshore and Dive Time at Low Tide", xlab="Distance Offshore (m)", ylab="Dive Time (second)", pch=19)
abline(lm(dive_time_obs~meters_offshore), col="black")
```

### Statistics
```{r}
dive_metersoffshore_corr <- cor.test(x=loons_dive_2024_gis_low$meters_offshore, y = loons_dive_2024_gis_low$dive_time_obs, method = 'spearman')
dive_metersoffshore_corr
```
 
 